;<MON>PROLOG.MAC;5    19-APR-77 15:30:04    EDIT BY SWEER
;un half killed some symbols for anal program
;<SCHULZ>PROLOG.MAC;3     2-DEC-76 16:21:41    EDIT BY SWEER
; ADD PSBIME, PSBLIN DEFINITIONS
;<SCHULZ>PROLOG.MAC;2    23-NOV-76 16:37:34    EDIT BY SWEER
;ADDED SPFOS JSYS
;<MON>PROLOG.MAC;22    10-SEP-75 12:35:23    EDIT BY CROSSLAND
;FIX SUGGESTED BY R SHULTZ TO FIX BAD PAGE ADDRESS TO REMFPG
;<MON>PROLOG.MAC		7/75		EDIT BY HEATHMAN
;ADDED TYMOP JSYS
;<MON>PROLOG.PAT;2    27-JAN-75 23:09:41    EDIT BY LIEB
;ADDED JSYS DEFS FOR NEW IMP  JSYS'S--LIEB
;<TENEX-130>PROLOG.MAC;87    27-NOV-72 13:54:11	EDIT BY TOMLINSON
;<TENEX-130>PROLOG.MAC;86    27-NOV-72 13:38:51	EDIT BY TOMLINSON
;<TENEX-130>PROLOG.MAC;85    20-NOV-72 17:47:12	EDIT BY WALLACE
;<TENEX-130>PROLOG.MAC;84    20-NOV-72 17:26:40	EDIT BY WALLACE
;<TENEX-130>PROLOG.MAC;83    20-NOV-72 15:32:14	EDIT BY TOMLINSON
;<TENEX-130>PROLOG.MAC;82    18-NOV-72 16:31:20	EDIT BY WALLACE
;<TENEX-130>PROLOG.MAC;81    13-NOV-72 11:44:15	EDIT BY TOMLINSON
; ADDED ESOUT AND SPLFK JSYS'S
;<TENEX-130>PROLOG.MAC;80    10-NOV-72 10:02:09	EDIT BY TOMLINSON
;<TENEX-130>PROLOG.MAC;79     9-NOV-72 17:23:58	EDIT BY TOMLINSON
; FIX UP BUG STRING REMOTER
;<TENEXDLM>PROLOG.MAC;78    30-OCT-72 19:08:24	EDIT BY TOMLINSON
; BIGGER UPDL 1 LESS UACB
;<TENEXDLM>PROLOG.MAC;77    18-SEP-72 15:28:55	EDIT BY MURPHY
;<TENEXDLM>PROLOG.MAC;76    18-SEP-72 13:30:12	EDIT BY MURPHY
;<TENEXDLM>PROLOG.MAC;75    14-SEP-72 16:59:11	EDIT BY MURPHY
;<TENEXDLM>PROLOG.MAC;74     8-AUG-72 21:49:07	EDIT BY MURPHY
;<TENEXDLM>PROLOG.MAC;73     7-AUG-72 21:45:57	EDIT BY MURPHY

;26 JUN 72, 1724:

	UNIVERSAL PROLOG
	PASS2

;GENERAL PARAMETERS AND MACROS

EOL=37			;END OF LINE CHARACTER

UMODF==10000		;USER MODE FLAG IN PC WORD
UIOF==4000		;USER I/O MODE IN PC WORD
NUPDL==120		;PDL FOR MONITOR CALLS

NFKS=2*NJOBS+^D50	;NUMBER OF FORKS
NSAC==16		;HIGHEST AC SAVED BY MENTR
NTERMI==^D36		;NUMBER OF TERMINAL INTERRUPTS
NPILEV==3		;NUMBER OF PSEUDO-INTERRUPT LEVELS
NPIPDL==40		;SIZE OF PSI LOCAL PDL
NTSK==50		;SIZE OF PAGE TRAP PDL
NUFKS==30		;MAX NUMBER FORKS/JOB
NLFKS==20		;NUMBER OF LOCAL FORKS
NWSPGS==<1000/44>+1	;SIZE OF WORKING SET PAGES BIT TABLE, 1 BIT/PG

APRCHN==3		;APR PI CHANNEL
SCDCHN==7		;SCHEDULER PI CHANNEL

PI==4			;DEVICE CODE FOR PI

;PAGER BITS

READB==1B20		;READ ALLOW
WRITEB==1B21		;WRITE ALLOW
XCTB==1B22		;EXECUTE ALLOW

TRAPUB==1B26		;TRAP TO USER BIT
ACCESB==1B30		;ACCESS ALLOW
COPYB==1B27		;COPY ON WRITE
CORMB=1B9		;MODIFIED BIT IN CST0

RWXB==READB+WRITEB+XCTB+ACCESB	;ALL ACCESS
RWX==RWXB-ACCESB

;SYSTEM CAN RUN WITH BBN 1 MS KLUDGE CLOCK, DEC DK10 CLOCK, OR NEITHER

IFE DK10F,<		;ASSUME BBN CLOCK, WORK EVEN IF NOT PRESENT

OAP==20			;CLOCK DEVICE (ORIGINALLY FOR OTHER APR)

DEFINE MSCKON
<	CONO OAP,1B29>	;CLOCK ON

DEFINE MSCKOF
<	CONO OAP,1B29>	;CLOCK OFF (SAME THING, STATE COMPLEMENTS)

DEFINE SOMSCK
<	CONSO OAP,1B28>	;SKIP IF CLOCK FLAG SET

DEFINE MSCKCL
<	CONO OAP,1B28>	;CLEAR CLOCK FLAG
   >			;END OF BBN CLOCK DEFS

IFN DK10F,<		;DEC HIGH RESOLUTION CLOCK, TIMES 1 MS INTERVALS

CLK==070

DEFINE MSCKON
<	CONO CLK,1B30+APRCHN>

DEFINE MSCKOF
<	CONO CLK,1B29+APRCHN>

DEFINE SOMSCK
<	CONSO CLK,1B31+1B32>	;CHECKS OVERFLOW TOO

DEFINE MSCKCL
<	CONO CLK,1B31+1B32+APRCHN>
   >			;END OF DK10 CLOCK DEFS

;BITS FOR CONI/CONO APR

IFN KIFLG,<
APNXM==1B29
APCHNS==<APRCHN>B32+APRCHN	;APR HAS 2 PI ASMTS
>
IFN KAFLG,<
APNXM==1B23
APCHNS==APRCHN
>


;MONITOR MAP BOUNDARIES
IFN KIFLG,<
 PPRMPG==340
 SWPMPG==400>

IFN KAFLG,<
 PPRMPG==174		;PER PROCESSOR REGION
 SWPMPG==200>		;PER PROCESSOR REGION

PJMPG==600		;PER JOB REGION
PPMPG==740		;PER PROCESS REGION

PPRMA==<PPRMPG>B26
SWPMA==<SWPMPG>B26
PJMA==<PJMPG>B26
PPMA==<PPMPG>B26

;SWAPPER PAGES RESERVED IN PROCESSOR-PRIVATE AREA

DEFINE ASNPPG (P,N)
<P==PPGCT
PPGCT=PPGCT+N
P'A=<P>B26 >

PPGCT==PPRMPG		;ASSIGNMENT START AT LOWEST MAPPED AREA

ASNPPG CSWPG,1		;SWAPPER TEMP
ASNPPG FITPG,1		;FORK INIT TEMP
ASNPPG PRLPG,1		;PRELOAD/POSTPURGE TEMP
   IFN KIFLG,<
ASNPPG KIPG,1>		;TEMP FOR KI SIMUL ROUTINE
ASNPPG PIPG,1		;FOR REAL-CORE REFS AT PI LEVEL

NRSPG==PPGCT-PPRMPG	;NUMBER OF SPECIAL PAGES

;SPECIAL RESERVED AREA FOR MDDT REENTRANT CODE
;PRIVATE SEGMENT LIVES IN PER-PROCESS AREA

LMDDT==10000		;LENGTH OF MDDT AREA
MDDTPG==PJMPG-LMDDT/1000 ;DDT LIVES AT HIGH END OF SWPMON AREA
MDDT=<MDDTPG>B26

;JOB-COMMON AREA

JSBPG==PJMPG		;JSB IS FIRST PAGE IN JOB-COMMON AREA
JSB=<JSBPG>B26

FREJP==PJMPG+4		;4 PAGES RESERVED FOR JSB EXPANSION
FREJPA=<FREJP>B26

;JFN STORAGE PARAMETERS

JFNPC0=JSB+454			;MUST BE ADJUSTED IF JSB STORAGE GROWS
NJFNW==1_SJFN			; = 2^SJFN
MJFN=<<FREJPA-JFNPC0>/NJFNW> ;MAX NUMBER JFNS
RJFN=MJFN*NJFNW			;ACTUAL SPACE USED BY JFNS

;PROCESS-PRIVATE AREA

PSB=777000		;PSB IS TOP PAGE OF MAP
PSBPG==<PSB>B44

UPTA=PSB-1000		;USER PAGE TABLE
UPTPG==<UPTA>B44

UACPG==PSBPG-4		;VIRTUAL PAGE FOR AC SAVE BLOCKS

KIEPT=PSB-2000		;PAGE TABLE MAPPED
KIEPG==PSBPG-2

DEFINE ASNPPG (P,N)
<P==PPGCT
PPGCT=PPGCT+N
P'A=<P>B26 >

PPGCT=PPMPG		;VARIOUS PROCESS RESERVED PAGES

ASNPPG CXBPG,1		;SWAPPER, MAP TEMP
ASNPPG CPTPG,1		; ..
ASNPPG CPYPG,1		; ..
ASNPPG DDPG1,1		;DDMP
ASNPPG DDPG2,1		; ..
ASNPPG PSIPG,1		;PSI IN PROGRESS STORAGE
ASNPPG FTPG1,1		;FORK
ASNPPG FPBPG,1		;FORK, HOLDS OBJECT PSB

FPG2==DDPG1		;USED BY SSAVE
FPG2A=DDPG1A
FPG3==DDPG2
FPG3A=DDPG2A
DDTPPG==774		;MDDT PRIVATE SEGMENT

ALRMAX==0		;NUMBER OF PAGES RESERVED FOR ALR
ALRVAL==10-<ALRMAX>B40	;3-BIT QUANTITY FOR PAGER ALR

;AC DEFINITIONS

P=17		;UNIVERSAL STACK

OPDEF JSYS [104B8]
OPDEF CALL [PUSHJ P,0]
OPDEF RET [POPJ P,0]
IFN KAFLG,<
OPDEF XCTUU [XCT 7,0]
OPDEF XCTMU [XCT 1,0]
OPDEF XCTUM [XCT 4,0]
OPDEF XCTBU [XCT 1,0]>
IFN KIFLG,<
OPDEF XCTUU [XCT 3,0]
OPDEF XCTMU [XCT 2,0]
OPDEF XCTUM [XCT 1,0]
OPDEF XCTBU [XCT 3,0]

DEFINE UMOVE (A,L)
<	XCTUU [MOVE A,L]>
DEFINE UMOVEM (A,L)
<	XCTUU [MOVEM A,L]>
DEFINE UMOVEI (A,L)
<	PRINTX	!UMOVEI NOT AVAILABLE ON KI-10!>
DEFINE UMOVES (A,L)
<	XCTUU [MOVES (A,L)]>
>;END OF KI-10 DEFINITIONS

;LOCAL STORAGE ALLOCATION MACRO

DEFINE LS (T,N)
<	IFB <N>,<ASSIGN T,RESVLC,1>
	IFNB <N>,<ASSIGN T,RESVLC,N>>

;GLOBAL STORAGE

DEFINE GS (T,N)
<	IFB <N>,<ASSIGN T,RESVLC,1>
	IFNB <N>,<ASSIGN T,RESVLC,N>
>

DEFINE KS (T,N)
<	IFB <N>,<ASSIGN T,KILOCS,1>
	IFNB <N>,<ASSIGN T,KILOCS,N>
>

;SWAPPABLE STORAGE

DEFINE NGS (T,N)
<	IFB <N>,<ASSIGN T,NRESLC,1>
	IFNB <N>,<ASSIGN T,NRESLC,N>
>

;SWAPPABLE STORAGE ASSIGNED PAGE-AT-A-TIME

DEFINE NGSP(T,N)
<	IFB <N>,<ASSIGN T,NRPLOC,1000>
	IFNB <N>,<ASSIGN T,NRPLOC,N*1000>
>


;SWAPPABLE, RESIDENT CODE

DEFINE SWAPCD<USE SWAPPC>
DEFINE RESCD<USE RESPC>

;REDEFINE TITLE TO DO ALL NECESSARY INITIAL THINGS

SYN TITLE,%TITLE

DEFINE TITLE(TT)
<	%TITLE TT
   IF2,<IFDEF SCDV1,<
	TSMAC(TTS)
	JSMAC(JJS)>
     IFDEF LDINIT,<
	JSYSLC==0
	EXTERN UJSYS
	JDMAC(LJD)>
   >
>

OPDEF PIOFF [CONO PI,1B27]
OPDEF PION [CONO PI,1B28]

DEFINE NOPI < PIOFF
		AOS NOPILK>

DEFINE OKPI < 	SKIPGE NOPILK
		JSR BUGCHK
		SOSGE NOPILK
		PION >

DEFINE CHNOFF (CHN)
<	CONO PI,1B26+1B<28+CHN>>

DEFINE CHNON (CHN)
<	CONO PI,1B25+1B<28+CHN>>

DEFINE TESTI(CHN)
<	CONSZ PI,1B<28+CHN>>
DEFINE ISB (CHN)
<	CONO PI,4000+1B<28+CHN>>
IFN KIFLG,<
DEFINE CLSB (CHN)
<	CONO PI,1B22+1B<28+CHN>>
>

DEFINE SCPU0,<
	PUSHJ P,CPUSW0>	;SWITCH TO CPU0

DEFINE SCPU1,<
	PUSHJ P,CPUSW1>	;SWITCH TO CPU1

DEFINE SKCPU0,<
	CONSO 250,25>	;RUNNING ON MAIN CPU

DEFINE SKCPU1,<
	CONSZ 250,25>	;RUNNING ON CPU1

DEFINE UNBRK (DEV)
<	EXTERN DEV'CHR
	JRST DEV'CHR>

;INSTRUCTION TRAP ERROR

DEFINE ITERR (ERN)
<IFNB <ERN>,<
	EXTERN ERN
	JRST [	MOVEI 1,ERN
		JRST ITRAP1]
>
IFB <ERN>,<
	JRST ITRAP
>>
DEFINE RETERR (ERN)
<IFNB <ERN>,<
	EXTERN ERN
	JRST [	MOVEI 1,ERN
		JRST MRETNE]
>
IFB <ERN>,<
	JRST MRETN
>>

;SCHEDULING CONTROL MACROS

DEFINE NOSWAP
<	AOS NSWAP>

DEFINE OKSWAP
<	SOSG NSWAP
	AOS ISKED>

DEFINE RESKED
<	AOS ISKED
	ISB SCDCHN>

DEFINE NOSKED
<	AOS NSKED>

DEFINE OKSKED
<	SOSG NSKED
	XCT RSKED >

;THIS CALL USED BY SCHEDULER. CANNOT BE JSYS ON KI-10
IFN KAFLG,<
DEFINE ENTSKD
<	JSYS ENSKED>>
IFN KIFLG,<
DEFINE ENTSKD
<	JSR ENSKR>>
;NOSKED AND OKSKED FOR CODE POSSIBLY BEING RUN UNDER SCHEDULER

DEFINE NOSKD1
<	SKIPN INSKED
	AOS NSKED>

DEFINE OKSKD1
<	SKIPN INSKED
	SOSLE NSKED
	CAIA
	XCT RSKED>

;PSI CONTROL

DEFINE NOINT
<	AOS INTDF>

DEFINE OKINT
<	XCT INTDFF>

DEFINE TSTINT
<	SKIPE PSIBW>


DEFINE HLOCK(A) <
	PUSH P,1
	MOVEI 1,A
	PUSHJ P,HLOCKR
	POP P,1>

DEFINE HLOCKI(A) <
	PUSH P,1
	MOVEI 1,A
	PUSHJ P,HLOCKP
	POP P,1 >

DEFINE HULOCK(A)< SETOM A>

DEFINE DLOCK(A)<
	PUSH P,1
	MOVEI 1,A
	PUSHJ P,DLOCKR
	POP P,1>

DEFINE ULOCK(A) <
	IFIDN <A> <SYSLCK>, <PUSHJ P,USYSLK>
	IFDIF <A> <SYSLCK>,<
	PUSH P,1
	SOS 1,A
	CAMGE 1,[-1]
	JSR BUGCHK
	POP P,1>
>

DEFINE SLOCK(A,B) <
	IFB <B>,<MOVEI 1,A
		PUSHJ P,SLOCKR>
	IFNB <B>,<
		MOVE 2,B
		MOVEI 1,A
		PUSHJ P,SLCKR1>
>

DEFINE JLOCK <
		PUSHJ P,JLOCKR>

DEFINE JULOCK <PUSHJ P,JULCKR>




IFN KAFLG,<	;PAGER INSTRUCTIONS

;CLEAR AR'S AND LOAD PARAMETERS

DEFINE PGRCLD
<	CONO PGR,0>

;CLEAR SPECIFIC MONITOR PAGE

DEFINE MONCLR(A)
<	CONO PGR,1>	;CLEARS ALL MON AR'S

;LOAD AGE REGISTER

DEFINE PGRLAG
<	CONO PGR,0>	;MUST DO WHOLE WORKS

;TURN ON PAGING (EXCEPT RESMON)

DEFINE PGRON
<	CONO PGR,6
	DATAO APR,[XWD 776776,0]>

;TURN OFF PAGING (MAKE ALL REFS GO TO REAL CORE)

DEFINE PGROFF
<	CONO PGR,4>

DEFINE SETACB (A)
<	DPB A,[POINT 5,PGR71,22]
	CONO PGR,10>
 >	;END OF KA PAGER DEFS

IFN KIFLG,<	;KI-10 PAGER INSTRUCTIONS, MUUO'S,ETC.

;MONITOR LUUO'S

OPDEF .IMCLR [1B8]	;MONITOR MAP CLEAR

;TRAP MUUO'S

OPDEF .PGTRP [40B8]	;PAGE FAULT, USER OR MONITOR
OPDEF .AROVT [41B8]	;AR OV, USER ONLY
OPDEF .PDOVT [42B8]	;PDL OV, USER OR MONITOR


;NO-TRAP UUO'S ARE JSYS (104) AND TOPS-10 MONITOR CALLS,DEFINED ELSEWHERE

;PAGER INSTRUCTIONS - TO IMPLEMENT KA10/BBN-PAGER SET

DEFINE PGRCLD
<	JSR KIPCLD>	;CLEAR AR'S AND LOAD PARAMETERS

DEFINE MONCLR(A)<
	IFE A,< .IMCLR >
	IFN A,<	IFLE 400-A,<
			IFE A&1,<HRRZS KIEPT+A/2>
			IFN A&1,<HLLZS KIEPT+A/2>>
		IFG  400-A,<
			PUSH P,1
			MOVE 1,KXUPT
			IFE A&1,<HRRZS 400+<A-340>/2(1)>
			IFN A&1,<HLLZS 400+<A-340>/2(1)>
			POP P,1 >
			DATAO PAG,KIPGWD
	>>

DEFINE MONSET(A,B,C)<
	IFLE 400-A,<
		IFE A&1,<HRLM B,KIEPT+A/2>
		IFN A&1,<HRRM B,KIEPT+A/2>>
	IFG 400-A,<
		PUSH P,C
		MOVE C,KXUPT
		IFE A&1,<HRLM B,400+<A-340>/2(C)>
		IFN A&1,<HRRM B,400+<A-340>/2(C)>
		POP P,C >
>

DEFINE SETKIM(A,X1,X2,%L1)<
	PUSH P,X1
	PUSH P,X2
	LDB X2,[POINT 13,X1,26]
	PIOFF				;FIX SUGGESTED BY R. SCHULTZ
	MOVE X2,SPT(X2)
	TLNE X2,17
	JRST %L1
	LDB X1,[POINT 9,CST0(X2),8]
	CAIGE X1,100
	JRST %L1
	MOVSI X1,(CORMB)
	TDNE X1,CST0(X2)
	IORI X2,KIWB
	IORI X2,KIAXB
	MONSET(A,X2,X1)
%L1:	PION					;FIX SUGGESTED BY R. SCHULTZ
	POP P,X2
	POP P,X1
>
DEFINE PGRLAG
<	CALL KIPLAG>	;LOAD AGE REG

DEFINE PGRON
<	DATAO PAG,KIPGWA
	SKCPU0
	DATAO PAG,KIPGWB
	JSR KIPCLD>	;TURN ON PAGING

DEFINE PGROFF
<	DATAO PAG,[400000]>	;TURN OFF PAGING

DEFINE SETACB(A)
<	DPB A,[POINT 5,PGR71,22]
	JSR KIPSAB>	;SET AC BASE REG
 >	;END OF KI DEFS

;TS BLOCK ASSIGNMENTS

UACB=PSB+440		;ADDRESS OF FIRST BLOCK FOR AC STORAGE
EUACB==PSB+560		;END OF AC BLOCKS IN PSB

ACBAS=PSB+570		;LOCATION OF AC'S FOR FORCED USER REFS
TRAPS0=PSB+571		;PAGER TRAP STATUS WORD
TRAPWD=PSB+572		;PAGER TRAP WRITE DATA
TRAPPC=PSB+573		;PAGER TRAP PC
TRAPAP=PSB+574		;PAGER TRAP AC-P
TRAPSW=PSB+575		;TRAP OLD STATUS WORD
UTRSW=PSB+576		;SAVED TRAPSW FOR USER
UTRWD=PSB+577		;SAVED TRAPWD FOR USER

DEFINE TTS (T,N)
<	IFB <N>,<ASSIGN T,TSBLOC,1>
	IFNB <N>,<ASSIGN T,TSBLOC,N>
>

DEFINE ETS (T,N)
<	EXTERN T
>

DEFINE TSMAC (TS)
<
TS JOBNO,1		;JOB NUMBER TO WHICH THIS FORK BELONGS
TS JOBBIT,1		;SCHEDULER CONTROL BITS
TS JOBCK0,1		;VARIABLES FOR SCHEDULER TIME QUARANTEE
TS JOBCK1,1		; ..

TS FKTAB,NLFKS/2	;LOCAL FORK HANDLE TO JOB HANDLE TABLE

TS FORKN,1		;JOB FORK NUMBER OF TOP FORK,,THIS FORK
TS FKRT,1		;FORK RUN TIME
TS ENTVEC,1		;ENTRY VECTOR POINTER
TS PATADR,1		;10/50 COMPATABILITY ENTRY VECTOR
TS PATU40,1		;WHERE TO STORE C(40), SETUP AS UMOVEM 1,XX
TS PATUPC,1		;WHERE TO STORE PC, SETUP AS UMOVEM 1,YY

TS MPP,1		;MONITOR SAVED STACK POINTER AT LAST MENTR
TS UPP,1		;MON ROUTINES STACK POINTER
TS SLOWF,1		;SLOW MON ROUTINE FLAG
TS XMENTR,1		;MENTR-MRETN TEMP
TS XMENT1,1		;MENTR TEMP
TS INTDF,1		;DEFER INTERRUPTS IF .GE. 0
TS INTDFF,1		;SOS INTDF  OR JSYS PSISV1
TS MJRSTF,1		;JRSTF @FPC  OR  JRST PSISV0
TS ACBAS1,1		;ACBAS FOR FIRST MON CALL

TS TW1,1		;DEBRK TEMPS
TS TW2,1

IFN IMSSS,<
TS TW3,1		;USED BY PBTIN >

TS ITFPC,1		;FPC AT LAST ITRAP
TS KITMPS,2		;KI-10 MUUO HANDLER TEMPS

TS PAC,20		;PROCESS AC'S
TS PPC,1		;PROCESS PC
TS PSB40,1		;PROCESS LOCATION 40

TS ENSKR,2		;SCHEDULER TEMP (RETURN)
TS SKDPC,1		;SCHEDULER TEMP (RETURN)
TS NSKED,1		;NO-SCHEDULE WORD
TS RSKED,1		;NO-SCHEDULE TRAP
TS NSWAP,1		;NO-SWAP FLAG

TS TRAPSK,NTSK		;STACK USED DURING PAGER TRAPS
TS PGTIM,1		;TIME SINCE AGE REG TICK
TS IFTIM,1		;TIME SINCE LAST PAGE FAULT
TS TRAPC,1		;PAGER TRAP RECURSION COUNT
TS UTRPCT,1		;COUNT OF PAGER TRAPS FOR THIS PROCESS
TS USWPCT,1		;COUNT OF SWPINW CALLS FOR THIS PROCESS
TS PTTIM,1		;TIME SPENT IN PAGER TRAPS
TS IFAV,1		;INTER-FAULT AVERAGE, CONTINUOUSLY MAINTAINED
TS CAPT,1		;WORKING SET WINDOW SIZE IN MS.
TS WSPGS,NWSPGS		;WORKING SET PAGES BIT TABLE
XWSPGS=<Z WSPGS-PSB+FITPGA>

TS MONBK,1		;INTERRUPT TO MONITOR IF NON-0
TS PIPC,1		;SAVED PC DURING INITIAL PI SERVICE
TS PIMSK,1		;PSI REQUEST WORD BEING PASSED TO PSI SERVICE
TS PIPDB,NPIPDL		;PSI ROUTINES STACK
TS PIAC,20		;SAVED USER AC'S DURING BREAK START

TS PSICHA,NTERMI/6	;CHANNEL ASSIGNED TO TERM CODE
TS PSIBW,1		;BREAK WAITING WORD
TS FORCTC,1		;CHANNEL WHICH CAUSED FORCED FORK TERMINATION
TS PSICHM,1		;CHANNEL ENABLED WORD
TS SUPCHN,1		;CHANNELS RESERVED BY SUPERIOR
TS PSIBIP,1		;BREAK IN PROGRESS WORD (LEVELS)
TS PSIPT,1		;PSI STORAGE LIST POINTER
TS PIOLDS,1		;FKSTAT PRIOR TO PSI IF WAS WAITING
TS LEVCHN,1		;LEVEL TABLE,,CHANNEL TABLE  ADDRESSES
TS PSISYS,1		;NON-0 IF PSI SYSTEM OFF
TS MONCHN,1		;CHANNELS RESERVED BY MONITOR
TS MONINT,1		;FOR DDT BREAKPOINTS
TS OVFLG,1		;NON-0 =) INITIATE INTERRUPTS ON MONITOR OV'S

TS UPDL,NUPDL		;PDL FOR MONITOR CALLS

TS FPC,1		;MENTR-MRETN JSYS PC
TS PSBIME,1		;SAVE IMECHF
TS PSBLIN,1		;SAVE LINKF
TS SAVFPC,1		;SAVE FPC PRIOR TO ANY XCT MJRSTF
>
	TSMAC (ETS)		;DEFINE AS EXTERNAL ALWAYS

;JOB STORAGE BLOCK ASSIGNMENTS

DEFINE JJS (T,N)
<	IFB <N>,<ASSIGN T,JSBLOC,1>
	IFNB <N>,<ASSIGN T,JSBLOC,N>
>

DEFINE EJS (T,N)
<	EXTERN T
>

DEFINE JSMAC (JS)
<
JS JOBMAP,PPMPG-PJMPG	;OBJECT MAP FOR JOB-COMMON AREA

JS SYSFK,NUFKS		;JOB FORK INDEX TO SYSTEM FORK INDEX
JS FKPTRS,NUFKS		;FORK POINTERS (STRUCTURE)
JS FKPSIE,NUFKS		;TERM INTERRUPT ENABLED WORD
JS FKDPSI,NUFKS		;DEFERRED TERM INTERRUPTS MASK
JS FREJFK,1		;FREE JOB FORK SLOT LIST

JS CTRLTT,1		;LINE NUMBER OF CONTROLLING TTY
JS TTSPSI,1		;CODE ENABLED ANYWHERE IN THIS JOB
JS TTSDPS,1		;TERM INT CODE DEFERRED
JS TTJTIW,1		;TERMINAL INTERRUPT ENABLE MASK
JS JOBPMF,1		;JFN OF PRIV MEM FILE
JS PMFCNT,1		;COUNT OF PMF PMAPS
JS CONSTO,1		;CONSOLE TIME ON
JS ACCTPT,1		;ACCOUNT NUMBER+5B2 OR ACCOUNT STRING PTR
JS LOGBUF,5		;LOGIN-OUT EFACT DATA, MUST PRECEDE ACCTSR
JS ACCTSR,11		;ACCOUNT STRING
>
	JSMAC (ETS)		;DEFINE AS EXTERNAL ALWAYS

;JSYS DISPATCH TABLE, INITIALIZED TO ALL ILLEGAL

DEFINE JJD (N,A)
<	OPDEF N [JSYS A]
>

;THE FOLLOWING USED ONLY IN LDINIT

DEFINE LJD (N,A)
<	LOC 1000+JSYSLC
	IFL A-JSYSLC,<PRINTX JSYS'S MUST BE DEFINED IN ORDER>
	REPEAT A-JSYSLC,<XWD FPC,UJSYS>
	EXTERN .'N
	XWD FPC,.'N
JSYSLC==.-1000
	RELOC
>

DEFINE JDMAC (JD)
<
JD LOGIN,1
REPEAT 0,<JD CRJOB,2>
JD LGOUT,3
JD CACCT,4
JD EFACT,5
JD SMON,6
JD TMON,7
JD GETAB,10
JD ERSTR,11
JD GETER,12
JD GJINF,13
JD TIME,14
JD RUNTM,15
JD SYSGT,16
JD GNJFN,17
JD GTJFN,20
JD OPENF,21
JD CLOSF,22
JD RLJFN,23
JD GTSTS,24
JD STSTS,25
JD DELF,26
JD SFPTR,27
JD JFNS,30
JD FFFFP,31
JD RDDIR,32
REPEAT 0,<JD CPRTF,33>
JD CLZFF,34
JD RNAMF,35
JD SIZEF,36
JD GACTF,37

JD STDIR,40
JD DIRST,41
JD BKJFN,42
JD RFPTR,43
JD CNDIR,44
JD RFBSZ,45
JD SFBSZ,46
JD SWJFN,47
JD BIN,50
JD BOUT,51
JD SIN,52
JD SOUT,53
JD RIN,54
JD ROUT,55
JD PMAP,56
JD RPACS,57
JD SPACS,60
JD RMAP,61
JD SACTF,62
JD GTFDB,63
JD CHFDB,64
JD DUMPI,65
JD DUMPO,66
JD DELDF,67
JD ASND,70
JD RELD,71
REPEAT 0,<JD CSYNO,72>
JD PBIN,73
JD PBOUT,74
REPEAT 0,<JD PSIN,75>
JD PSOUT,76
JD MTOPR,77

JD CFIBF,100
JD CFOBF,101
JD SIBE,102
JD SOBE,103
JD DOBE,104
JD GTABS,105
JD STABS,106
JD RFMOD,107
JD SFMOD,110
JD RFPOS,111
JD RFCOC,112
JD SFCOC,113
JD STI,114
JD DTACH,115
JD ATACH,116
JD DVCHR,117
JD STDEV,120
JD DEVST,121
JD MOUNT,122
JD DSMNT,123
JD INIDR,124
JD SIR,125
JD EIR,126
JD SKPIR,127
JD DIR,130
JD AIC,131
JD IIC,132
JD DIC,133
JD RCM,134
JD RWM,135
JD DEBRK,136
JD ATI,137
JD DTI,140
JD CIS,141
JD SIRCM,142
JD RIRCM,143
JD RIR,144
JD GDSTS,145
JD SDSTS,146
JD RESET,147

JD RPCAP,150
JD EPCAP,151
JD CFORK,152
JD KFORK,153
JD FFORK,154
JD RFORK,155
JD RFSTS,156
JD SFORK,157
JD SFACS,160
JD RFACS,161
JD HFORK,162
JD WFORK,163
REPEAT 0,<JD GFRKH,164
JD RFRKH,165>
JD GFRKS,166
JD DISMS,167
JD HALTF,170
JD GTRPW,171
JD GTRPI,172
JD RTIW,173
JD STIW,174
JD SOBF,175
JD RWSET,176
JD GETNM,177

JD GET,200
JD SFRKV,201
JD SAVE,202
JD SSAVE,203
JD SEVEC,204
JD GEVEC,205
JD GPJFN,206
JD SPJFN,207
JD SETNM,210
JD FFUFP,211
JD DIBE,212
JD FDFRE,213
JD GDSKC,214
JD LITES,215
JD TLINK,216
JD STPAR,217

JD ODTIM,220
JD IDTIM,221
JD ODCNV,222
JD IDCNV,223
JD NOUT,224
JD NIN,225
JD STAD,226
JD GTAD,227
JD ODTNC,230
JD IDTNC,231
JD FLIN,232
JD FLOUT,233
JD DFIN,234
JD DFOUT,235

JD CRDIR,240
JD GTDIR,241
JD DSKOP,242
JD SPRIW,243
JD DSKAS,244
JD SJPRI,245

IFDEF DSPCHN,<
JD ASNDP,260		; E&S JSYS'S
JD RELDP,261
JD ASNDC,262
JD RELDC,263
JD STRDP,264
JD STPDP,265
JD STSDP,266
JD RDSDP,267
JD WATDP,270
>

IFDEF IMPCHN,<
JD ATPTY,274
JD CVSKT,275
JD CVHST,276
JD FLHST,277
>

JD GCVEC,300
JD SCVEC,301
JD STTYP,302
JD GTTYP,303
JD BPT,304
JD GTDAL,305
JD WAIT,306
JD HSYS,307
JD USRIO,310
JD PEEK,311
JD MSFRK,312
JD ESOUT,313
JD SPLFK,314
JD ADVIZ,315
JD JOBTM,316
JD DELNF,317
JD SWTCH,320

JD OPRFN,326			;!! MAH @ SUMEX 4/75 !!

JD DRMOP,357
JD ASPTY,360
JD REPTY,361
JD PSTI,362
JD PSTO,363
JD SIBF,364
JD SRUBA,365
REPEAT 0,<
JD INTLK,366
>
IFN SUMEX,<
JD SFPOS,526
>
IFN IMSSS,<
JD PBTIN,600		;BYTE IN AND TIME
JD TTCVT,601		;CONVERT TTYS TO HSL
JD KIDNO,602		;READ/SET KIDDIE NUMBER
JD LOGSV,603		;WRITE LOGSAV DATA
JD DATSV,604		;SAVE KIDDIE DATA
JD SCEDR,605		;READ LOGIN SCHEDULE
JD SCEDS,606		;SET LOGIN SCHEDULE
>;end of imsss
JD CNTSZ,607		;COUNT FORK(S),SIZE FOR ANY JOB
IFN IMSSS,<
JD SYSLK,610		;LOOK AT A SYSTEM LOCATION
>;END OF IMSSS
JD PSTIN,611		;STRING INPUT
JD RAND,612		;RANDOM NUMBER GENERATOR
IFN IMSSS,<
JD KLGOT,613		;HALTF IF EXEC- LOGOUT IF KIDDY
>;end of imsss
JD PTINF,614		;PUTINF JSYS
JD GTINF,615		;GETINF JSYS
IFN IMSSS,<
;JD SETWS,616		;SET WORKING SET ENTRIES
;JD CLRWS,617		;CLEAR WORKING SET ENTRIES
;JD AUTWS,620		;SET AUTO WS SWITCH
;JD RDWS,621		;READ WORKING SET
;JD CLAWS,622		;CLEAR WHOLE WORKING SET
JD KLGIN,623		;KIDDY LOGIN JSYS

JD DEVCT,624		;DEVICE IO JSYS
>;end of imsss
JD DELCH,625
JD SJPCT,626	;SET JOB PRIORITY
JD RJPCT,627	;READ JOB PRIORITY
JD IIT,630		;TIMER INTERRUPT
JD STCHA,633		;SET STOP CHARACTER
JD GTBLT,634		;BLT SYSTABLES

;TYMNET JSYS'S ALLOW ABOUT 10 FOR EXPANSION
IFDEF TYMSW,<
JD TYMBW,651		;store a word into TYMNET interface page
JD TYMBR,652		;get a word from the TYMNET interface page
JD TYMLI,653		;get connected TYMNET line node info
JD TYMOP,654		;TYMNET functions, will replace TYMLI
>

;SUMEX JSYS's ALLOW ABOUT 20(8) FOR EXPANSION
IFN SUMEX, <
JD VKEEP,674		;set # versions to retain for a file
JD PRGE,675		;expunge a single file
>	

IFDEF IMPCHN,<
JD SNDIM,750	;ADDED WITH NEW IMPDV.133
JD RCVIM,751
JD ASNSQ,752
JD RELSQ,753
>
IFDEF IMPCHN,<
JD DBGIM,766>

;TEMPORARY DEF'S
JD MRPAC,772
JD TTMSG,775
JD EXEC,777
>
	JDMAC (JJD)		;OPDEF ALL

	.END

